<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FREE YOUR MIND — Matrix Text RPG</title>
<style>
  :root{ --green:#32ff6a; --cyan:#39d2ff; --ink:#073b19; --light:#cffff3; }
  html,body{height:100%}
  body{margin:0;background:#000;color:#aef6cf;font-family:ui-monospace, monospace}
  /* Ensure anything [hidden] is REALLY gone in all engines */
  [hidden]{display:none !important}

  #rain{position:fixed;inset:0;z-index:0;opacity:.42}
  #app{position:relative;z-index:1}
  .log{padding:6rem 1rem 7.5rem;height:100vh;overflow:auto;white-space:pre-line}
  .hud{position:fixed;top:.8rem;right:.8rem;font-size:12px;background:rgba(0,0,0,.55);border:1px solid var(--green);border-radius:8px;padding:10px 12px;color:#baffec;z-index:3;min-width:260px}
  .inputDock{position:fixed;left:50%;transform:translateX(-50%);bottom:1.1rem;width:min(980px,94vw);display:flex;gap:.5rem;z-index:3}
  .text{flex:1;background:rgba(0,0,0,.6);border:1px solid var(--green);color:#daf;padding:.85rem;font:16px/1.2 monospace;border-radius:.5rem}
  .btn{background:var(--ink);border:1px solid var(--green);color:#e8ffee;padding:.6rem .95rem;border-radius:.5rem;cursor:pointer}

  /* Home overlay */
  .home{
    position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    text-align:center;z-index:4;background:rgba(0,0,0,.65)
  }
  .title{font-size:46px;letter-spacing:.08em;margin:0 0 .25rem 0;color:#baffec}
  .subtitle{opacity:.85;margin:.25rem 0 .9rem}
  .pillRow{display:flex;gap:1rem;margin-top:1rem;justify-content:center}
  .pill{width:140px;height:44px;border-radius:28px;border:2px solid var(--green);box-shadow:0 0 12px rgba(0,255,120,.25);transition:transform .08s, box-shadow .08s;cursor:pointer}
  .pill:hover{transform:translateY(-2px);box-shadow:0 0 20px rgba(0,255,150,.35)}
  .red{background:#c31010}
  .blue{background:#0b57d0}
  .quote{margin-top:1rem;color:#9ff;max-width:680px}
  .instructions{margin-top:12px;text-align:left;max-width:740px;color:#baffec;font-size:14px}
  .instructions ol{padding-left:1.2rem}
</style>
</head>
<body>
<canvas id="rain"></canvas>
<div id="app">
  <!-- HUD -->
  <div id="hud" class="hud" hidden>
    <div><strong id="hudName">Neo</strong> — <span id="hudLvl">L1</span></div>
    <div>HP: <span id="hpText">120/120</span></div>
    <div>MP: <span id="mpText">50/50</span></div>
    <div>Weapon: <span id="hudWpn">Matrix Blade</span></div>
    <div>Credits: <span id="hudCred">80</span></div>
  </div>

  <!-- Log -->
  <div id="log" class="log"></div>

  <!-- Input -->
  <div class="inputDock" id="inputDock" hidden>
    <input id="cmd" class="text" placeholder="Type an action… (try: answer phone, hide, run)"/>
    <button class="btn" id="go">Enter</button>
  </div>

  <!-- Home -->
  <div id="home" class="home" aria-modal="true" aria-hidden="false">
    <div class="title">FREE YOUR MIND</div>
    <div class="subtitle">How far down the rabbit hole do you want to go?</div>
    <div class="pillRow" role="group" aria-label="Choose your path">
      <!-- HARD FALLBACK: inline onclick -->
      <button id="red" type="button" class="pill red" aria-label="Take the red pill (start)" onclick="startGame()">Red Pill</button>
      <button id="blue" type="button" class="pill blue" aria-label="Take the blue pill (exit)">Blue Pill</button>
    </div>
    <div class="quote">Morpheus: “You take the blue pill — the story ends… You take the red pill — you stay in Wonderland, and I show you how deep the rabbit hole goes.”</div>
    <div class="instructions">
      <strong>How to play</strong>
      <ol>
        <li>Click <em>Red Pill</em> to begin — the overlay disappears and the terminal appears.</li>
        <li>Type actions like <code>answer phone</code>, <code>hide</code>, <code>run</code>, <code>market</code> then press Enter.</li>
      </ol>
    </div>
  </div>
</div>

<script>
/* ===== Matrix Code Rain ===== */
(function(){
  const c=document.getElementById('rain'); const ctx=c.getContext('2d');
  const resize=()=>{c.width=innerWidth; c.height=innerHeight;}; resize(); addEventListener('resize',resize);
  const fs=14; let cols=Math.floor(innerWidth/fs); let drops=new Array(cols).fill(1);
  const glyphs=[...'アカサタナハマヤラワ0123456789'];
  function draw(){ ctx.fillStyle='rgba(7,10,7,0.08)'; ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle='#32ff6a'; ctx.font=fs+'px monospace';
    for(let i=0;i<drops.length;i++){
      const ch=glyphs[(Math.random()*glyphs.length)|0];
      ctx.fillText(ch,i*fs,drops[i]*fs);
      if(drops[i]*fs>c.height && Math.random()>0.975) drops[i]=0;
      drops[i]+=1.12;
    }
    requestAnimationFrame(draw);
  } requestAnimationFrame(draw);
})();

/* ===== UI Refs ===== */
const ui={
  home:document.getElementById('home'),
  red:document.getElementById('red'),
  blue:document.getElementById('blue'),
  log:document.getElementById('log'),
  hud:document.getElementById('hud'),
  inputDock:document.getElementById('inputDock'),
  cmd:document.getElementById('cmd'),
  go:document.getElementById('go')
};

/* ===== State ===== */
let state={
  phase:'home',
  log:["Wake up, Neo…"],
  player:{name:'Neo',level:1,hp:120,mp:50,weapon:'Matrix Blade',credits:80}
};

/* ===== Render ===== */
function render(){
  // keep this resilient to bad state
  let out = Array.isArray(state.log) ? state.log.join('\n') : String(state.log||'');
  if (!out) out = "Wake up, Neo…";
  ui.log.textContent = out;

  const ingame = (state.phase === 'game');
  ui.hud.hidden = !ingame;
  ui.inputDock.hidden = !ingame;
}

/* ===== Start Game (robust) ===== */
function startGame(){
  // move to game phase
  state.phase='game';
  // seed the log with an obvious prompt so you SEE the terminal changed
  state.log=[
    "Wake up, Neo…",
    "The Matrix has you.",
    "",
    "Type an action (examples):",
    "  - answer phone",
    "  - hide",
    "  - run",
    ""
  ];

  // HARD hide overlay with multiple levers
  ui.home.hidden = true;
  ui.home.setAttribute('aria-hidden','true');
  ui.home.style.display = 'none';

  // paint the terminal and ensure it's on top & focused
  render();
  // safety: after paint, scroll & focus
  setTimeout(()=>{
    try{
      ui.log.scrollTop = ui.log.scrollHeight;
      ui.cmd.focus();
    }catch(e){}
  },0);

  // last resort safety: if overlay somehow still visible after 300ms, force it off
  setTimeout(()=>{
    if (!ui.home.hasAttribute('hidden')) {
      ui.home.hidden = true;
      ui.home.style.display = 'none';
    }
  },300);
}

/* ===== Submit ===== */
function submit(cmd){
  if(state.phase!=='game' || !cmd) return;
  state.log.push('> '+cmd);
  if(/^answer phone$/i.test(cmd)) {
    state.log.push("A whisper through static: 'They're coming.' The cubicle walls hum with code.");
  } else if (/^hide$/i.test(cmd)) {
    state.log.push("You press behind the partition. Footsteps pass. Time stretches.");
  } else if (/^run$/i.test(cmd)) {
    state.log.push("You bolt. The corridor spills green glyphs as alarms blossom behind you.");
  } else if (/^market$/i.test(cmd)) {
    state.log.push("A black market flickers in an alley subroutine. (Soon: trade commands.)");
  } else {
    state.log.push("The Matrix responds…");
  }
  render();
  // keep the cursor ready
  setTimeout(()=>{ try{ ui.cmd.focus(); }catch(e){} }, 0);
}

/* ===== Events (redundant backups) ===== */
ui.red.addEventListener('click', startGame);
ui.red.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') startGame(); });
// Global: Enter/Space on title also starts
document.addEventListener('keydown',(e)=>{
  if(!ui.home.hasAttribute('hidden') && (e.key==='Enter' || e.key===' ')) startGame();
});

// Blue pill
ui.blue.addEventListener('click', ()=>window.open('https://www.youtube.com/watch?v=dQw4w9WgXcQ','_blank'));

// Input actions
ui.go.addEventListener('click',()=>{
  const v=ui.cmd.value.trim();
  ui.cmd.value='';
  submit(v);
});
ui.cmd.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    const v=ui.cmd.value.trim();
    ui.cmd.value='';
    submit(v);
  }
});

/* ===== Initial Paint ===== */
render();
</script>
</body>
</html>
