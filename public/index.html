<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FREE YOUR MIND — Matrix Text RPG</title>
<style>
  :root{
    --green:#32ff6a; --cyan:#39d2ff; --ink:#07b319; --light:#e8fff3;
    --bg:#000; --panel:rgba(0,0,0,.65);
  }
  html,body{height:100%}
  body{margin:0;background:#000;color:#aefccf;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;overflow:hidden}

  /* Hidden kill-switch for overlays */
  [hidden]{display:none!important}

  #rain{position:fixed;inset:0;z-index:0;opacity:.42}
  #app{position:relative;z-index:1}

  /* HUD */
  .hud{position:fixed;right:.8rem;top:.6rem;background:var(--panel);border:1px solid var(--green);
       padding:.4rem .6rem; font-size:.85rem; color:#baffec; z-index:2}
  .hud b{color:var(--green)}

  /* Home overlay */
  .home{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;z-index:2;background:linear-gradient(to bottom,rgba(0,0,0,.1),rgba(0,0,0,.8))}
  .title{font-size:46px;letter-spacing:.08em;margin:.2rem 0 .25rem 0;color:#baffec}
  .subtitle{opacity:.85;margin:.25rem 0 .9rem}
  .pillRow{display:flex;gap:.6rem;margin-top:.4rem;justify-content:center}
  .pill{width:140px;height:44px;border-radius:28px;border:2px solid var(--green);box-shadow:0 0 20px rgba(0,255,150,.35);transition:.08s transform, box-shadow .08s;cursor:pointer;background:#001a10;color:#baffec}
  .pill:hover{transform:translateY(-1px);box-shadow:0 0 28px rgba(0,255,150,.55)}
  .red{border-color:#c31010;color:#ffd9d9}
  .blue{border-color:#0570d4;color:#b0d8ff}
  .quote{margin-top:1rem;color:#9ff;max-width:820px;font-size:14px}

  /* Terminal */
  .log{position:fixed;left:5%;right:5%;bottom:5.8rem;height:52vh;max-width:980px;margin-inline:auto;background:var(--panel);border:1px solid var(--green);padding:.8rem;overflow:auto;white-space:pre-wrap}
  .inputDock{position:fixed;left:5%;right:5%;bottom:1.4rem;max-width:980px;margin-inline:auto;display:flex;gap:.6rem;z-index:1}
  .text{flex:1; background:#000;border:1px solid var(--green);padding:.7rem .8rem;color:#caffef;border-radius:.45rem;font-size:16px}
  .btn{background:var(--ink);border:1px solid var(--green);color:#e8fffe;padding:.65rem 1rem;border-radius:.45rem;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:wait}
  .help{font-size:12px;opacity:.7;margin-top:.35rem;text-align:center}
  .actions{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
  .tag{font-size:12px; border:1px dashed var(--cyan); color:#b8f6ff; padding:.15rem .4rem; border-radius:.4rem; cursor:pointer}
  .saveNote{position:fixed;left:50%;transform:translateX(-50%);bottom:.3rem;font-size:12px;color:#9ff;opacity:.75}
</style>
</head>
<body>
<canvas id="rain"></canvas>

<div id="app">
  <!-- HUD -->
  <div class="hud" id="hud">
    <div><b>Name:</b> <span id="pname">Neo</span> · <b>Lvl:</b> <span id="plvl">1</span></div>
    <div><b>HP:</b> <span id="php">100</span> · <b>MP:</b> <span id="pmp">40</span> · <b>Credits:</b> <span id="pcr">0</span></div>
    <div><b>Weapon:</b> <span id="pwpn">Fists</span></div>
  </div>

  <!-- Home -->
  <div class="home" id="home">
    <div class="title">FREE YOUR MIND</div>
    <div class="subtitle">How far down the rabbit hole do you want to go?</div>
    <div class="pillRow">
      <button class="pill red" id="red">Red Pill</button>
      <a class="pill blue" id="blue" target="_blank" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" rel="noopener">Blue Pill</a>
    </div>
    <div class="quote">“You take the blue pill — the story ends… You take the red pill — you stay in Wonderland, and I show you how deep the rabbit hole goes.”</div>
    <div class="help">Open the <b>Instructions</b> in the log after starting: try <code>answer phone</code>, <code>hide</code>, <code>run</code>, <code>market</code>, and in fights use <code>attack</code>, <code>hack</code>, <code>defend</code>, <code>focus</code>, <code>scan</code>, <code>overclock</code>, or items like <code>item Health Pack</code>.<br/>You can also type literally anything. The engine adapts and remembers.</div>
  </div>

  <!-- Terminal -->
  <div class="log" id="log" hidden></div>
  <div class="inputDock" id="dock" hidden>
    <input id="cmd" class="text" placeholder="Type anything. Enter to send…" autocomplete="off"/>
    <button id="go" class="btn">Send</button>
  </div>
  <div class="saveNote" id="saveNote" hidden>Progress saved.</div>
</div>

<script>
/* ===== Matrix Code Rain (background) ===== */
const canvas = document.getElementById("rain");
const ctx = canvas.getContext("2d");
function size() { canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener("resize", size); size();
const glyphs = "アイウエオｱｲｳｴｵABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
const font = 14, cols = () => Math.floor(canvas.width / font);
let drops = [];
function initDrops(){ drops = Array(cols()).fill(1); }
initDrops(); addEventListener("resize", initDrops);
setInterval(()=> {
  ctx.fillStyle = "rgba(0,0,0,0.06)"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#0f0"; ctx.font = font+"px monospace";
  for (let i=0;i<drops.length;i++){
    const ch = glyphs.charAt(Math.floor(Math.random()*glyphs.length));
    ctx.fillText(ch, i*font, drops[i]*font);
    if (drops[i]*font > canvas.height && Math.random() > .975) drops[i]=0;
    drops[i]++;
  }
}, 33);

/* ===== Game State & Memory (client) ===== */
const ui = {
  home: document.getElementById("home"),
  log: document.getElementById("log"),
  dock: document.getElementById("dock"),
  cmd: document.getElementById("cmd"),
  go: document.getElementById("go"),
  saveNote: document.getElementById("saveNote"),
  hp: document.getElementById("php"),
  mp: document.getElementById("pmp"),
  cr: document.getElementById("pcr"),
  lv: document.getElementById("plvl"),
  wpn: document.getElementById("pwpn"),
  name: document.getElementById("pname"),
  red: document.getElementById("red"),
  blue: document.getElementById("blue")
};

const KEY = "fym_v1";
const save = (obj)=>localStorage.setItem(KEY, JSON.stringify(obj));
const load = ()=>{ try {return JSON.parse(localStorage.getItem(KEY))||null;} catch {return null;} };

const store = load() || {
  state: { name:"Neo", level:1, hp:100, mp:40, credits:0, weapon:"Fists", location:"apartment", flags:{} },
  memory: { facts:[], goals:[], npcs:{}, prefs:{} },
  log: []
};
renderHud();

function renderHud(){
  ui.name.textContent = store.state.name;
  ui.lv.textContent = store.state.level;
  ui.hp.textContent = store.state.hp;
  ui.mp.textContent = store.state.mp;
  ui.cr.textContent = store.state.credits;
  ui.wpn.textContent = store.state.weapon;
}
function append(s){ ui.log.innerHTML += s + "\n"; ui.log.scrollTop = ui.log.scrollHeight; }

/* ===== Start ===== */
ui.red.addEventListener("click", ()=>{
  ui.home.setAttribute("hidden","");
  ui.log.removeAttribute("hidden");
  ui.dock.removeAttribute("hidden");
  ui.cmd.focus();
  if (store.log.length === 0) {
    append("Wake up, Neo… The Matrix has you.\nType anything to act. Try: answer phone, hide, run, market, scan, overclock, item Health Pack.\n");
  } else {
    append("Session restored. Continue your story.\n");
    store.log.forEach(line => append(line));
  }
});

document.addEventListener("keydown", (e)=>{
  if (!ui.home.hasAttribute("hidden") && (e.key === "Enter" || e.key === " ")) {
    ui.red.click();
  }
});

function pushLog(line) {
  store.log.push(line);
  if (store.log.length > 40) store.log.shift();
  save(store);
}

async function submit(input) {
  input = input.trim();
  if (!input) return;
  append("> " + input);
  pushLog("> " + input);

  // local commands (instant)
  if (input.toLowerCase() === "save") { save(store); flashSave(); return; }
  if (input.toLowerCase() === "reset") { localStorage.removeItem(KEY); location.reload(); return; }
  if (input.toLowerCase() === "help") {
    append("Try verbs like: answer, scan, hide, jump, run, talk, hack, overclock, defend, market, or just describe what you do. The engine adapts and remembers.");
    return;
  }

  // call AI
  ui.go.disabled = true;
  try {
    const res = await fetch("/api/ai", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        playerInput: input,
        state: store.state,
        memory: store.memory,
        log: store.log.slice(-14)
      })
    });
    const data = await res.json();

    // Merge patches safely
    if (data.effects) {
      if (Number.isFinite(data.effects.hpDelta)) store.state.hp += data.effects.hpDelta;
      if (Number.isFinite(data.effects.mpDelta)) store.state.mp += data.effects.mpDelta;
      if (Number.isFinite(data.effects.creditsDelta)) store.state.credits += data.effects.creditsDelta;
    }
    if (data.state_patch) Object.assign(store.state, data.state_patch);
    if (data.memory_patch) deepMerge(store.memory, data.memory_patch);
    renderHud();

    const narration = data.narration || "Static hums. Your move still matters.";
    append(narration);
    pushLog(narration);

    // show suggested actions as clickable tags
    if (Array.isArray(data.actions) && data.actions.length) {
      const row = document.createElement("div"); row.className = "actions";
      data.actions.slice(0,6).forEach(a=>{
        const span = document.createElement("span"); span.className="tag";
        span.textContent = a.label || a.cmd || "";
        span.addEventListener("click", ()=>{ ui.cmd.value = a.cmd || a.label; ui.cmd.focus(); });
        row.appendChild(span);
      });
      ui.log.appendChild(row); ui.log.scrollTop = ui.log.scrollHeight;
      pushLog("(actions updated)");
    }

    save(store);
  } catch (e) {
    console.error(e);
    append("Connection crackles. Try again, or use verbs like scan / hide / run / answer. (We won’t stall.)");
  } finally {
    ui.go.disabled = false;
  }
}

ui.go.addEventListener("click", ()=>{
  const v = ui.cmd.value; ui.cmd.value = ""; submit(v);
});
ui.cmd.addEventListener("keydown", e=>{
  if (e.key === "Enter") { const v = ui.cmd.value; ui.cmd.value=""; submit(v); }
});

function deepMerge(target, patch){
  if (!patch || typeof patch !== "object") return;
  for (const k of Object.keys(patch)) {
    const pv = patch[k];
    if (pv && typeof pv === "object" && !Array.isArray(pv)) {
      if (!target[k] || typeof target[k] !== "object") target[k] = {};
      deepMerge(target[k], pv);
    } else {
      target[k] = pv;
    }
  }
}
function flashSave(){
  ui.saveNote.removeAttribute("hidden");
  setTimeout(()=>ui.saveNote.setAttribute("hidden",""), 1200);
}
</script>
</body>
</html>

